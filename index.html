<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Poverty Under Lula</title>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/cerulean/bootstrap.min.css" 
    integrity="sha384-3fdgwJw17Bi87e1QQ4fsLn4rUFqWw//KU0g8TvV6quvahISRewev6/EocKNuJmEw" crossorigin="anonymous">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin=""
  />
  <link
    href="http://fonts.googleapis.com/css?family=Lato"
    rel="stylesheet"
    type="text/css"
  />

  <style>
    #map {
      width: 100%;
      height: 40vh;
    }

    #about {
      max-height: 80vh;
      overflow-y: scroll;
    }

    /* .borough {
      fill: white;
      stroke-width: 1px;
      stroke: black;
      /* vector-effect: non-scaling-stroke; */
    /* }

    /* Small devices (landscape phones, 576px and up) */
    @media (min-width: 576px) {}

    /* Medium devices (tablets, 768px and up) */
    @media (min-width: 768px) {
      #map {
        height: 60vh;
      }
    }

    /* Large devices (desktops, 992px and up) */
    @media (min-width: 992px) {

      #map {
        height: 80vh;
      }
    }

    /* Extra large devices (large desktops, 1200px and up) */
    @media (min-width: 1200px) {}

    /* /* .state {
      fill: none;
      stroke: #eb7f86;
      stroke-width: 2;
    } */

    /* .county {
      fill: #fac484;
      stroke: #f8a07e;
    }

    .county:hover {
      fill: #f3e79b;
      stroke: #eb7f86;
      stroke-width: 2;
    } */
  </style>

</head>

<body>

  <div class="container-fluid">
    <header class="row py-3 bg-dark text-white">
      <div class="col mx-2">
        <h1 class="h1">Here's how far poverty fell in Brazil under Lula da Silva</h1>
      </div>
    </header>

    <section class="row bg-secondary">
      <div class="col-12 col-md-7 col-lg-8 px-0">
        <div id="map" class="bg-light position-relative"></div>
      </div>
      <aside id="about" class="col-12 col-md-5 col-lg-4 text-dark py-2">
        <section>
          <h2 class="h2 text-dark">What social democracy can accomplish</h2>
          <p>TK: background on data, image insert</p>
        </section>
      </aside>
    </section>
    <footer class="row bg-dark text-white py-3">
      <div class="col mx-2">
        <ul class="list-unstyled">
          <li>Author: Tim Higginbotham</li>
          <li>December 8, 2020</li>
          <li><a href="">Data</a></li>
        </ul>
      </div>
    </footer>
  </div> <!-- end .container-fluid -->


  <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
  
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" 
    integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </script>

  <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
  <!-- <script src="https://unpkg.com/topojson@3"></script> -->

  <script>
// map options
      const options = {
        scrollWheelZoom: false,
        zoomSnap: 0.1,
        dragging: false,
        zoomControl: false,
      };

      // create the Leaflet map
      const map = L.map("map", options);

      // // request tiles and add to map
      // const tiles = L.tileLayer(
      //   "http://{s}.tile.stamen.com/toner-background/{z}/{x}/{y}.{ext}",
      //   {
      //     attribution:
      //       'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      //     subdomains: "abcd",
      //     ext: "png",
      //   }
      // ).addTo(map);

      // AJAX request for GeoJSON data
      $.getJSON("data/brazil-states.json", function (counties) {
        Papa.parse("data/brazil-poverty-and-pop.csv", {
          download: true,
          header: true,
          complete: function (data) {
            processData(counties, data);
          },
        });
      });

      function processData(counties, data) {
        // loop through all the counties
        for (let i of counties.features) {
          // for each of the CSV data rows
          for (let j of data.data) {
            // if the county fips code and data fips code match
            if (i.properties.ADM1_PT === j.Region) {
              // re-assign the data for that county as the county's props
              i.properties = j;

              // no need to keep looping, break from inner loop
              break;
            }
          }
        }

        // empty array to store all the data values
        const rates = [];

        // iterate through all the counties
        counties.features.forEach(function (county) {
          // iterate through all the props of each county
          for (const prop in county.properties) {
            // if the attribute is a number and not one of the fips codes or name
            if (prop != "Country" && prop != "ISO_Code" && prop != "Level" && prop != "GDLCODE" && prop != "Region") {
              // push that attribute value into the array
              rates.push(Number(county.properties[prop]));
            }
          }
        });
        // create class breaks
        var breaks = chroma.limits(rates, "q", 5);

        // create color generator function
        var colorize = chroma
          .scale(chroma.brewer.OrRd)
          .classes(breaks)
          .mode("lab");

        drawMap(counties, colorize);
        drawLegend(breaks, colorize);
      }

      function drawMap(counties, colorize) {
        // create Leaflet object with geometry data and add to map
        const dataLayer = L.geoJson(counties, {
          style: function (feature) {
            return {
              color: "black",
              weight: 1,
              fillOpacity: 1,
              fillColor: "#1f78b4",
            };
          },
        }).addTo(map);

        // first set the zoom/center to the dataLayer's extent
        map.fitBounds(dataLayer.getBounds());

        // then back the zoom level off a bit (since we're viewing the map full screen)
        map.setZoom(map.getZoom() - 0.2);

        //create slider UI
        createSliderUI(dataLayer, colorize);

        //initially color map with first timestamp
        updateMap(dataLayer, colorize, "poverty-2003");
      } //end drawMap

      function updateMap(dataLayer, colorize, currentYear) {
        // loop through each layer
        dataLayer.eachLayer(function (layer) {
          //shorthand for properties
          const props = layer.feature.properties;

          //update color to match timestamp
          layer.setStyle({
            fillColor: colorize(Number(props[currentYear])),
          });

          //build tooltip
          const tooltip = `<b>${props["Region"]}</b><br />
            ${props[currentYear]}% in poverty`;

          //bind tooltip to layer
          layer.bindTooltip(tooltip, {
            sticky: true,
          });
        });
      } // end updateMap

      function drawLegend(breaks, colorize) {
        // create a Leaflet control for the legend
        const legendControl = L.control({
          position: "topright",
        });

        // when the control is added to the map
        legendControl.onAdd = function (map) {
          // create a new division element with class of 'legend' and return
          const legend = L.domUtil.create("div", "legend");
          return legend;
        };

        // add the legend control to the map
        legendControl.addTo(map);

        const legend = $(".legend").html(
          "<H3><span>2003</span> Percent in extreme poverty </H3><ul>"
        );

        //loop through the break values
        for (let i = 0; i < breaks.length - 1; i++) {
          //access color for each class range
          const color = colorize(breaks[i]);

          //build a list item with color blocks and values
          const classRange = `<li><span style="background:${color}"></span>
                              ${breaks[i].toLocaleString()}% &mdash;
                              ${breaks[i + 1].toLocaleString()}%</li>`;

          //append the list item to the list
          $("legend ul").append(classRange);
        }

        //close unorderdered list
        legend.append("</ul>");
      } // end drawLegend()

      function createSliderUI(dataLayer, colorize) {
        const sliderControl = L.control({ position: "bottomleft" });
        //when added to the map
        sliderControl.onAdd = function (map) {
          //create leaflet control for the slider
          const slider = L.DomUtil.get("ui-controls");

          //disable scrolling of map while using controls
          L.DomEvent.disableScrollPropagation(slider);

          //disable click events while using controls
          L.DomEvent.disableClickPropagation(slider);

          //return the slider from the onAdd method
          return slider;
        };

        // Add the control to the map
        sliderControl.addTo(map);

        // select the form event
        $(".year-slider").on("input change", function () {
          //when user changes
          const currentYear = $(this).val(); //update the year
          updateMap(dataLayer, colorize, currentYear); // update the map with current timestamp
          $(".legend H3 span").html(currentYear); // update timestamp in legend heading
        });
      } // end createSliderUI()
    
  </script>
</body>

</html>