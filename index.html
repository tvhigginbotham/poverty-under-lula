<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <title>Poverty Under Lula</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin=""
    />
    <link
      href="http://fonts.googleapis.com/css?family=Lato"
      rel="stylesheet"
      type="text/css"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cabin:wght@500&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Martel:wght@200&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        margin: 0px;
      }

      #map {
        background-color: rgb(37, 37, 37);
        float: left;
        width: 70%;
        height: 93vh;
        border-top: 3px groove whitesmoke;
        border-bottom: 3px groove whitesmoke;
      }

      #about {
        background-color: rgb(37, 37, 37);
        color: whitesmoke;
        width: calc(30% - 49px);
        height: 93vh;
        margin: auto;
        padding: 0px 20px 0px 25px;
        border-top: 3px groove white;
        border-bottom: 3px groove whitesmoke;
        border-left: 3px groove whitesmoke;
        overflow-y: scroll;
      }

      .img {
        width: 95%;
        float: left;
        text-align: left;
        padding: 10;
        margin: 10;
        border: 1px groove rgb(139, 132, 132);
      }

      .caption {
        text-align: left;
        padding:5px;
        font-size: 10px;
        font-family: "martel", serif;
        color: rgb(151, 145, 145);
      }

      .h1 {
        height: 6%;
        width: calc(100%-10px);
        margin: auto;
        padding: 5px 0px 5px 20px;
        background-color: rgb(37, 37, 37);
        color: whitesmoke;
        font-family: "Cabin", sans-serif;
      }

      .h2 {
        font-family: "cabin", sans-serif;
        font-weight: normal;
        margin-bottom: 0px;
      }

      .h3 {
        font-family: "martel", sans-serif;
        font-weight: lighter;
        font-size: 18px;
      }

      .p {
        font-family: "lato", sans-serif;
        font-weight: normal;
        font-size: 15px;
        line-height: 22px;
      }

      .p2 {
        font-family: "lato", sans-serif;
        font-weight: lighter;
        color:rgb(187, 181, 181);
        margin-top: 4px;
        font-size: 15px;
        line-height: 18px
      }

      .link {
        color: rgb(193, 206, 13);
        text-decoration: none;
        font-weight: bold;
      }

      /* Small devices (landscape phones, 300px and up) */
      @media (min-width: 300px) {
        #map {
          height: 70vh;
          width: 100%;
          border-top: 2px solid whitesmoke;
          border-bottom: 2px solid whitesmoke;
        }
        #about {
          height: 70vh;
          width: calc(100% - 45px);
          border: none;
        }
        .legend{
          visibility: hidden;
        }
      }

      /* Medium devices (tablets, 768px and up) */
      @media (min-width: 768px) {
        #map {
          height: 60vh;
          width: 70%;
          border-top: 3px groove whitesmoke;
          border-bottom: 3px groove whitesmoke;
        }
        #about {
          height: 70vh;
          width: calc(30% - 49px);
          border-top: 3px groove whitesmoke;
          border-bottom: 3px groove whitesmoke;
          border-left: 3px groove whitesmoke;
        }
        .legend{
          visibility: visible;
        }
      }

      /* Large devices (desktops, 992px and up) */
      @media (min-width: 992px) {
        #map {
          height: 93vh;
          width: 70%;
          border-top: 3px groove whitesmoke;
          border-bottom: 3px groove whitesmoke;
        }
        #about {
          height: 93vh;
          width: calc(30% - 49px);
          border-top: 3px groove whitesmoke;
          border-bottom: 3px groove whitesmoke;
          border-left: 3px groove whitesmoke;
        }
      }

      /* Extra large devices (large desktops, 1200px and up) */
      @media (min-width: 1200px) {
      }

      .legend {
        margin-bottom: 15px;
        font-size: 1em;
        background: rgba(17, 17, 17, 0.8);
        color: whitesmoke;
        box-shadow: 2px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        width: 180px;
      }

      .legend h3 {
        font-size: 1.3em;
        font-family: "cabin", sans-serif;
        font-weight: bold;
        line-height: 1em;
        color: whitesmoke;
        margin-left: 20px;
      }

      .legend h3 span {
        font-size: 1.3em;
        margin: none;
      }

      .legend ul {
        list-style-type: none;
        padding: 0;
        font-family: "cabin", sans-serif;
        font-size: 13px;
        margin: 12px 0px 20px 20px;
      }

      .legend li {
        height: 22px;
      }

      .legend span {
        width: 30px;
        height: 20px;
        float: left;
        margin-right: 15px;
      }

      #ui-controls {
        width: 176px;
        margin: 0px 10px 10px 0px;
        padding: 8px 25px 8px 15px;
        background: rgba(17, 17, 17, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        color: whitesmoke;
      }

      #ui-controls .min {
        float: left;
      }

      #ui-controls .max {
        float: right;
        margin-right: -15px;
      }

      .year-slider {
        width: 100%;
      }

      .boxed {
        position: -webkit-sticky;
        position: sticky;
        margin: 0 auto;
        font-family: "cabin", sans-serif;
        font-size: 14px;
        font-style: bold;
        text-align: Center;
        background-color: rgba(131, 128, 128, 0.918);
        color: rgb(37, 37, 37);
        padding: 6px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        width: 70%;
        bottom: 4px;
      }

      label {
        font-size: 1.3em;
        font-family: "cabin", sans-serif;
        font-weight: bold;
      }

    </style>
  </head>

  <body>
    <div class="container-fluid">
      <header>
        <div>
          <h1 class="h1">
            Here's how far poverty fell in Brazil under President Lula da Silva
          </h1>
        </div>
      </header>

      <section>
        <div>
          <div id="map"></div>
          <div id="ui-controls">
            <label>
              <span class="min">2003</span>
              <span class="max">2010</span>
              <input
                type="range"
                min="2003"
                max="2010"
                value="2003"
                step="1"
                class="year-slider"
              />
            </label>
          </div>
        </div>
        <aside id="about">
          <section>
            <h2 class="h2">ABOUT THIS MAP</h2>
            <p class="p">
              In 2003, Brazil elected its first working-class president. Luis
              Inacio Lula da Silva — better known simply as "Lula" — took office
              with the promise of improving material conditions for Brazil's
              working majority.</p><p class="p">He followed through, most notably with 'Bolsa
              Família,' a social welfare program that puts money directly in the
              hands of the poor. When Lula left office in 2010, the share of
              Brazilians living in extreme poverty had fallen by over 83%.
            </p>
            <img
              class="img"
              src="graphics/lula-ricardoStuckert.png"
              alt="Pro-Lula Rally"
            />
            <figcaption class="caption">
              Photo by Ricardo Stuckert. Licensed by Creative Commons
            </figcaption>
            <p class="p2"
                ><b>—</b> This map was made using data from Radboud University's
                <a class="link" href="globaldatalab.org">Global Data Lab.</a
                ><br /><br /><b>—</b> "Extreme poverty" is defined by an
                <a class="link" href="https://globaldatalab.org/iwi/"
                  >International Wealth Index (IWI)</a
                >
                score below 35.
            </p>
            <div class="boxed">
              Map created by Tim Higginbotham<br />University of Kentucky: New
              Maps Plus<br />
              December 20, 2020
            </div>
          </section>
        </aside>
      </section>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>

    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
      integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin=""
    ></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script>
      // map options
      let parsedData;

      function getRegionRow(region) {
        for (let row of parsedData) {
          if (row["Region"] === region) {
            return row;
          }
        }
      }

      function getPopulation(region, year) {
        const row = getRegionRow(region);
        return row[year.replace("poverty-", "pop")];
      }     

      function getPovertyOverTimeForRegion(region) {
        const povertyValues = [];
        const row = getRegionRow(region);
        const povertyKeys = Object.keys(row).filter(function(key) {return key.startsWith('poverty')});
        for (let key of povertyKeys) {
          povertyValues.push(row[key]);
        }
        return povertyValues;
      }

      var range_map = $.range_map({
        '0:1': "#edf8e9",
        '1:5': "#c7e9c0",
        '5:10': "#a1d99b",
        '10:15': "#74c476",
        '15:20': "#31a354",
        '20:': "#006d2c"
    })
      
      const options = {
        scrollWheelZoom: false,
        zoomSnap: 0.2,
        dragging: false,
        zoomControl: false,
      };

      // create the Leaflet map
      const map = L.map("map", options);

      // AJAX request for GeoJSON data
      $.getJSON("data/brazil-states.json", function (states) {
        Papa.parse("data/brazil-poverty-and-pop.csv", {
          download: true,
          header: true,
          complete: function (data) {
            processData(states, data);
          },
        });
      });

      function processData(states, data) {
        parsedData = data.data;

        for (let i of states.features) {
          for (let j of data.data) {
            if (i.properties.ADM1_PT === j.Region) {
              i.properties = j;
              break;
            }
          }
        }

        // create class breaks
        var breaks = [0, 1, 5, 10, 15, 20, 33];
        var colorHex = [
          "#edf8e9",
          "#c7e9c0",
          "#a1d99b",
          "#74c476",
          "#31a354",
          "#006d2c",
        ];

        // create color generator function
        var colorize = chroma.scale(colorHex).classes(breaks).mode("lab");

        drawMap(states, colorize);
        drawLegend(breaks, colorize);
      }

      function drawMap(states, colorize) {
        // create Leaflet object with geometry data and add to map
        const dataLayer = L.geoJson(states, {
          style: function (feature) {
            return {
              color: "whitesmoke",
              weight: 1.5,
              fillOpacity: 1,
              fillColor: "#ffffff",
            };
          },
          // add hover/touch functionality to each feature layer
          onEachFeature: function (feature, layer) {
            layer.on("mouseover", function () {
              layer
                .setStyle({
                  color: "yellow",
                  weight: 4,
                })
                .bringToFront();
            });

            layer.on("mouseout", function () {
              layer.setStyle({
                color: "whitesmoke",
                weight: 1.5,
              });
            });
          },
        }).addTo(map);

        map.fitBounds(dataLayer.getBounds());

        createSliderUI(dataLayer, colorize);

        //initially color map with first timestamp
        updateMap(dataLayer, colorize, "poverty-2003");
      } //end drawMap

      function updateMap(dataLayer, colorize, currentYear) {
  
        dataLayer.eachLayer(function (layer) {
          const props = layer.feature.properties;
          const info = $("#info").hide();

          //update color to match timestamp
          layer.setStyle({
            fillColor: colorize(Number(props[currentYear])),
          });

          //build tooltip
          const regionId = props["Region"].replace(/ /g, '-');

          const tooltip = 
          `<span style="font-size: 150%; font-family: 'lato', sans-serif; color: black;">
          <b>${props["Region"]} </b></span><br/>
          <span style="font-size: 90%; font-family: 'lato', sans-serif;">
          (pop: ${getPopulation(props["Region"], currentYear)} million)</span></p>
          <p><span style="font-size: 120%; font-family: 'lato', sans-serif;">
          <b>In extreme poverty:</b> ${props[currentYear]}%</p>
          <hr style="width:100%;text-align:left;margin-left:0">
          <span style="font-size: 120%; font-family: 'lato', sans-serif;">
            <b>Trend (2003-2010):</b></span></p>
            <div class="trendspark ${regionId}"></div>`;

          //bind tooltip to layer
          layer.bindTooltip(tooltip, {
            sticky: true,
          });

          layer.on('tooltipopen', function() {
            const rates = getPovertyOverTimeForRegion(props["Region"]);
            $(`.trendspark.${regionId}`).sparkline(rates, {
              type: "bar",
              width: "130px",
              height: "80px",
              barWidth: 13.5,
              barSpacing: 7.5,
              colorMap: range_map, 
              chartRangeMin: 0,
              chartRangeMax: Math.max(rates),
              spotRadius: 0,
              lineWidth: 2,
            });
          });
        });
      } // end updateMap

      function drawLegend(breaks, colorize) {
        const legendControl = L.control({
          position: "bottomleft",
        });

        legendControl.onAdd = function (map) {
          const legend = L.DomUtil.create("div", "legend");
          return legend;
        };
        legendControl.addTo(map);

        const legend = $(".legend").html(
          "<H3><span>2003</span> <br> <br> Percent in extreme poverty</H3><ul>"
        );

        //loop through the break values
        for (let i = 0; i < breaks.length - 1; i++) {
          const color = colorize(breaks[i]);

          //build a list item with color blocks and values
          const classRange = `<li><span style="background:${color}"></span>
                              ${breaks[i].toLocaleString()}% &mdash;
                              ${breaks[i + 1].toLocaleString()}%</li>`;
          $(".legend ul").append(classRange);
        }
      } // end drawLegend()

      function createSliderUI(dataLayer, colorize) {
        const sliderControl = L.control({ position: "bottomright" });
        //when added to the map
        sliderControl.onAdd = function (map) {
          const slider = L.DomUtil.get("ui-controls");

          L.DomEvent.disableScrollPropagation(slider);

          L.DomEvent.disableClickPropagation(slider);

          return slider;
        };

        sliderControl.addTo(map);

        $(".year-slider").on("input change", function () {
          const currentYear = $(this).val(); //update the year
          updateMap(dataLayer, colorize, `poverty-${currentYear}`);
          $(".legend H3 span").html(currentYear);
        });
      } // end createSliderUI()
    </script>
  </body>
</html>
